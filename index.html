<!doctype html>
<!-- =========================================================
  NFC HUB (Path-based URLs) — Single GitHub Pages site
  =========================================================

  ✅ EDIT THESE (once)
  -------------------
  1) DEFAULT_THEME:
       Used if client JSON doesn't specify a theme.
  2) DATA_PATH:
       Where client JSON files live (default: ./data/clients/{slug}.json)

  HOW IT WORKS (Option A)
  -----------------------
  - You use URLs like:
      https://card.crestedcritters.com/test
      https://card.crestedcritters.com/sam

  - This page reads the first path segment as the slug:
      /test   → loads ./data/clients/test.json
      /sam    → loads ./data/clients/sam.json

  - It also supports a query fallback:
      ?client=test

  IMPORTANT FOR GITHUB PAGES
  --------------------------
  - GitHub Pages will 404 on /test unless you add a SPA fallback.
  - You said you added 404.html — this file restores the intended path.
========================================================= -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFC Card</title>
  <meta name="description" content="Tap to view contact info and links." />

  <link rel="stylesheet" href="/base.css" />
<link id="themeStylesheet" rel="stylesheet" href="/themes/theme-01-neon-dark.css" />
<link rel="icon" href="/logo.jpg" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@400;600&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
  <main class="wrap">
    <section class="card">

      <header class="hero">
        <a class="logo-link" id="logoLink" href="#" target="_blank" rel="noopener">
          <img class="logo" id="logoImg" src="./logo.jpg" alt="Business logo" />
        </a>

        <div class="titleblock">
          <h1 class="brand" id="brand">Loading…</h1>
          <p class="tagline" id="tagline"></p>
        </div>
      </header>

      <nav class="links" aria-label="Primary links">
        <a class="btn" id="btnWebsite" href="#" target="_blank" rel="noopener">Website</a>
        <a class="btn" id="btnFacebook" href="#" target="_blank" rel="noopener">Facebook</a>
        <a class="btn" id="btnTikTok" href="#" target="_blank" rel="noopener">TikTok</a>
        <a class="btn vcard" id="btnVcard" href="#" download>Save Contact</a>
      </nav>

      <section class="section">
        <h2>About</h2>
        <p id="about"></p>
      </section>

      <section class="section">
        <h2>Contact info</h2>

        <div class="contact-grid">
          <div class="contact-item">
            <div class="label">Name</div>
            <div class="value" id="contactName"></div>
          </div>

          <div class="contact-item">
            <div class="label">Phone</div>
            <div class="value"><a id="contactPhone" href="#"></a></div>
          </div>

          <div class="contact-item">
            <div class="label">Email</div>
            <div class="value"><a id="contactEmail" href="#"></a></div>
          </div>
        </div>

        <div class="quick-actions" aria-label="Quick actions">
          <a class="pill" id="pillCall" href="#">Call</a>
          <a class="pill" id="pillText" href="#">Text</a>
          <a class="pill" id="pillEmail" href="#">Email</a>
        </div>
      </section>

      <footer class="footer">
        <span>© <span id="year"></span> <span id="footerBrand"></span></span>
      </footer>

    </section>
  </main>

  <script>
    // =========================================================
    // ✅ EDIT THESE (global settings)
    // =========================================================
    const DEFAULT_THEME = "/themes/theme-01-neon-dark.css";
const DATA_PATH = (slug) => `/data/clients/${slug}.json`;

    const $ = (id) => document.getElementById(id);

    // =========================================================
    // Path / Query based slug (Option A)
    // =========================================================
    function getSlugFromPathOrQuery() {
      // 1) Optional: query param support (?client=test)
      const params = new URLSearchParams(location.search);
      const qClient = (params.get("client") || "").trim().toLowerCase();
      if (qClient) return qClient;

      // 2) Path support (/test, /test/, /test/anything)
      const parts = location.pathname.split("/").filter(Boolean);
      const first = (parts[0] || "").trim().toLowerCase();

      // If no path segment, show sample
      if (!first) return "sample";

      // If hosted as https://username.github.io/nfc-hub/test
      // then parts[0] is "nfc-hub" and parts[1] is the slug.
      if (location.hostname.toLowerCase().endsWith(".github.io")) {
        if (first === "nfc-hub" && parts.length >= 2) return (parts[1] || "sample").toLowerCase();
      }

      return first;
    }

    async function loadClient(slug) {
      const res = await fetch(DATA_PATH(slug), { cache: "no-store" });
      if (!res.ok) throw new Error(`Client "${slug}" not found (${res.status})`);
      return res.json();
    }

    function applyClient(c) {
  // Theme
  const themeHref = c.theme
    ? (c.theme.startsWith("/") ? c.theme : `/themes/${c.theme}`)
    : DEFAULT_THEME;

  // ✅ ADD THIS LINE (this is what actually applies the theme)
  document.getElementById("themeStylesheet").href = `${themeHref}?v=${Date.now()}`;

$("logoImg").src = c.logoPath || "/logo.jpg";
$("btnVcard").href = c.vcardPath || "/contact.vcf";

      // Title + footer
      document.title = c.businessName || "NFC Card";
      $("brand").textContent = c.businessName || "";
      $("footerBrand").textContent = c.businessName || "";

      $("tagline").textContent = c.tagline || "";
      $("about").textContent = c.about || "";

      // Logo + logo link
      $("logoImg").src = c.logoPath || "./logo.jpg";
      $("logoImg").alt = (c.businessName ? c.businessName + " logo" : "Business logo");
      $("logoLink").href = (c.links && c.links.website) ? c.links.website : "#";

      // Link buttons
      $("btnWebsite").href = c.links?.website || "#";
      $("btnFacebook").href = c.links?.facebook || "#";
      $("btnTikTok").href = c.links?.tiktok || "#";

      // vCard
      $("btnVcard").href = c.vcardPath || "./contact.vcf";

      // Contact
      $("contactName").textContent = c.contact?.name || "";
      const phoneE164 = c.contact?.phoneE164 || "";
      const phoneDisplay = c.contact?.phoneDisplay || phoneE164;

      $("contactPhone").href = phoneE164 ? `tel:${phoneE164}` : "#";
      $("contactPhone").textContent = phoneDisplay || "";

      const email = c.contact?.email || "";
      $("contactEmail").href = email ? `mailto:${email}` : "#";
      $("contactEmail").textContent = email || "";

      // Quick actions
      $("pillCall").href = phoneE164 ? `tel:${phoneE164}` : "#";
      $("pillText").href = phoneE164 ? `sms:${phoneE164}` : "#";
      $("pillEmail").href = email ? `mailto:${email}` : "#";
    }

    async function main() {
      $("year").textContent = new Date().getFullYear();

      // =========================================================
      // ✅ SPA RESTORE BLOCK (put it here)
      // This restores the intended /slug path after 404.html redirects to /
      // =========================================================
      const redirectPath = sessionStorage.redirectPath;
      if (redirectPath) {
        sessionStorage.removeItem("redirectPath");
        history.replaceState(null, "", redirectPath);
      }

      // ✅ This is the "update main()" part:
      // We now use path/query slug instead of hostname/subdomain.
      const slug = getSlugFromPathOrQuery();

      try {
        const client = await loadClient(slug);
        applyClient(client);
      } catch (err) {
        console.error(err);
        const client = await loadClient("sample");
        applyClient(client);
        $("brand").textContent = "Client not found";
        $("tagline").textContent = `No card configured for "${slug}". Showing sample.`;
      }
    }

    main();
  </script>
</body>
</html>
